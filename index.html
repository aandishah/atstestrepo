<!DOCTYPE html>
<html>
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="">
        <title>Weather & Twitter Exploration</title>
        <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
        <script src='js/geolet.js'></script>
        <script src="https://api.windy.com/assets/map-forecast/libBoot.js"></script>
        <link rel="canonical" href="https://getbootstrap.com/docs/5.1/examples/carousel/">
        <link href="assets/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="css/carousel.css" rel="stylesheet">
        <style text='text/css'>
          .bd-placeholder-img {
            font-size: 1.125rem;
            text-anchor: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
          }

          @media (min-width: 768px) {
            .bd-placeholder-img-lg {
              font-size: 3.5rem;
            }
          }

          .progress-bar {
            background-color: transparent;
            overflow: visible;
          }

          #windy .play-pause.off::before {
              content: 'f';
              left: .1em !important;
          }

          #windy .play-pause::before {
              content: 'e';
              position: relative;
              left: initial !important;
              top: .1em;
          }
        </style>
        <!--
        <script type="text/javascript" src="leaflet.js"></script>
        <script type="text/javascript" src="leaflet-openweathermap.js"></script> -->

        <!-- <link rel="stylesheet" type="text/css" href="leaflet-openweathermap.css" /> -->
        <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" /> -->
        <!-- <link rel='stylesheet' type='text/css' href='css/fontAwesome.css' /> -->
        <link rel='stylesheet' href='css/style.css' />
        <script src="js/secret_keys.js"></script>
        <script src='js/countries.js'></script>
        <script src='js/centroids.js'></script>
        <script src="js/city_list.js"></script>
    </head>
    <body>
        <h1 id='headline'><b>Weather & Twitter Exploration</b></h1>
        <!-- <div class='unit_switch' id='button_container'>
            <button onclick='switchUnits()' class="unit_switch">Switch Temperature Units</button>
            <span></span>
        </div> -->
        <header>
          <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
            <div class="container-fluid">
              <a class="navbar-brand" href="#">Weather & Twitter Exploration</a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarCollapse">
                <ul class="navbar-nav me-auto mb-2 mb-md-0">
                  <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="index2.html">Home</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="about.html">About the Team </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="https://forms.gle/fRxwtGYjSeKS3xaV8"> Feedback </a>
                  </li>
                </ul>
                <form class="d-flex">
                  <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
                  <button class="btn btn-outline-success" type="submit">Search</button> <!--This is not functional yet -->
                </form>
              </div>
            </div>
          </nav>
        </header>
        <div id="myCarousel" class="carousel slide" data-bs-ride="carousel">
          <div class="carousel-indicators">
            <button type="button" data-bs-target="#myCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
            <button type="button" data-bs-target="#myCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
            <button type="button" data-bs-target="#myCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
          </div>
          <div class="carousel-inner">
            <div class="carousel-item active">
              <img src="imgs/slide1.jpg" alt = "second slide">
              <div class="container">
                <div class="carousel-caption">
                  <h1>Hello! </h1>
                  <p>This website is a visual interface showing current weather trends, worldwide twitter trend and future weather forecast!</p>
                </div>
              </div>
            </div>
            <div class="carousel-item">
              <img src="imgs/current_trends.jpg" alt = "current trends">
              <div class="container">
                <div class="carousel-caption">
                  <h1>Click on the markers</h1>
                  <p>The blue will show you the twitter trends and the other will show you the weather trends!</p>
                </div>
              </div>
            </div>
            <div class="carousel-item">
              <img src="imgs/forecast.jpg" alt = "weather trends">
              <div class="container">
                <div class="carousel-caption">
                  <h1>Toggle the options on the top right corner</h1>
                  <p>Get the insights about various weather forecasts across the world! </p>
                </div>
              </div>
            </div>
          </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#myCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#myCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
        </div>
            <script src="assets/dist/js/bootstrap.bundle.min.js"></script>
        <div id="windy"></div>
        <script>


            const options = {
                // Required: API key
                key: windy_key,

                // Put additional console output
                verbose: true,

                // Optional: Initial state of the map
                lat: 0,
                lon: 0,
                zoom: 1,
            };

            function style(feature) {
                return {
                    fillColor: 'white',
                    weight: 4,
                    opacity: 1,
                    color: 'black',
                    // dashArray: '3',
                    fillOpacity: 0,
                };
            }

            const country_twitter_names = [
              "algeria",
              "argentina",
              "australia",
              "austria",
              "bahrain",
              "belarus",
              "belgium",
              "brazil",
              "canada",
              "chile",
              "colombia",
              "denmark",
              "dominican-republic",
              "ecuador",
              "egypt",
              "france",
              "germany",
              "ghana",
              "greece",
              "guatemala",
              "india",
              "indonesia",
              "ireland",
              "israel",
              "italy",
              "japan",
              "jordan",
              "kenya",
              "korea",
              "kuwait",
              "latvia",
              "lebanon",
              "malaysia",
              "mexico",
              "netherlands",
              "new-zealand",
              "nigeria",
              "norway",
              "oman",
              "pakistan",
              "panama",
              "peru",
              "philippines",
              "poland",
              "portugal",
              "puerto-rico",
              "qatar",
              "russia",
              "saudi-arabia",
              "singapore",
              "south-africa",
              "spain",
              "sweden",
              "switzerland",
              "thailand",
              "turkey",
              "ukraine",
              "united-arab-emirates",
              "united-kingdom",
              "united-states",
              "venezuela",
              "vietnam"
            ];
            // document.write(country_twitter_names);

            // Initialize Windy API
            windyInit(options, windyAPI => {
                // windyAPI is ready, and contain 'map', 'store',
                // 'picker' and other useful stuff

                const { map } = windyAPI;
                // .map is instance of Leaflet map

                var twitterIcon = L.icon({
                    iconUrl: 'icons/twitter.svg',
                    iconSize: [38, 95]
                });

                var weatherIcon = L.icon({
                    iconUrl: 'icons/weather.svg',
                    iconSize: [38, 95]
                })

                let weather_marker = L.marker();
                let weather_popup = L.popup();
                let twitter_marker = L.marker();
                let twitter_popup = L.popup();

                var geojson = L.geoJson(countryBorders, {style: style}).addTo(map);
                function onEachFeature(feature, layer) {
                  layer.on({
                    // mouseover: highlightFeature,
                    // mouseout: resetHighlight,
                    click: function onTwitterClick(e) {
                      
                      var country_fnams = feature.properties.country_fnams;
                      if (country_twitter_names.includes(country_fnams)) {
                        // Run per over the world
                        fetch("https://twitter-trend.p.rapidapi.com/trend/" + country_fnams, {
                          "method": "GET",
                          "headers": {
                            "x-rapidapi-host": "twitter-trend.p.rapidapi.com",
                            "x-rapidapi-key": "2d7408301cmshc36e87d99327887p141468jsna99ac1ad3b71"
                          }
                        })
                          .then(function (resp) { return resp.json() })
                          .then(function (data) {
                            console.log(data);
                            var trend0 = data[0].Trend.name;
                            var trend1 = data[1].Trend.name;
                            var trend2 = data[2].Trend.name;
                            var trend3 = data[3].Trend.name;
                            var trend4 = data[4].Trend.name;

                            twitter_popup
                              .setContent("<h2>What's trending on Twitter in " + country_fnams + "?</h2><br><h3><ol><li>" + trend0 +
                                "</li><br><li> " + trend1 + "</li><br><li> " + trend2 + "</li><br><li> " + trend3 + "</li><br><li> " +
                                trend4 + "</ol></h3>");
                          })
                      } else {
                        twitter_popup
                        .setContent('<h2>Twitter trends not available for ' + country_fnams + '</h2>');
                      }
                    }
                  });
                }
              countryCenters = L.geoJson(centroids, {
                // style: style,
                onEachFeature: onEachFeature
              }).addTo(map)
              .bindPopup(twitter_popup);

                // var countryCenters = L.geoJson(centroids).addTo(map).bindPopup(twitter_popup);

                // popup window showing top five trending topics on Twitter
                // function onTwitterClick(e) {

                //     // Run per over the world
                //     fetch("https://twitter-trend.p.rapidapi.com/", {
                //         "method": "GET",
                //         "headers": {
                //             "x-rapidapi-host": "twitter-trend.p.rapidapi.com",
                //             "x-rapidapi-key": "2d7408301cmshc36e87d99327887p141468jsna99ac1ad3b71"
                //         }
                //     })
                //         .then(function (resp) { return resp.json() })
                //         .then(function (data) {
                //             console.log(data);
                //             var trend0 = data[0].Trend.name;
                //             var trend1 = data[1].Trend.name;
                //             var trend2 = data[2].Trend.name;
                //             var trend3 = data[3].Trend.name;
                //             var trend4 = data[4].Trend.name;

                //             twitter_popup
                //                 .setContent("<h1>What's trending on Twitter?</h1><br><h2><ol><li>" + trend0 +
                //                     "</li><br><li> " + trend1 + "</li><br><li> " + trend2 + "</li><br><li> " + trend3 + "</li><br><li> " +
                //                     trend4 + "</ol></h2>");
                //         })
                // }

                // only shows country centroids if zoomed in enough
                map.on('zoomend', function (e) {
                    console.log(map.getZoom());
                    if (map.getZoom() > 3) {
                        countryCenters.addTo(map);
                    } else {
                        countryCenters.remove();
                    };
                });

                // If I want my map to appear on the extent of the GeoJson:
                // map.fitBounds(L.popup().getLatLng());

                function onMapClick(e) {
                    weather_marker
                    .setLatLng(e.latlng)
                    .setIcon(weatherIcon)
                    .addTo(map);

                    weather_marker.bindPopup(weather_popup);

                    // weather API integration
                    fetch("https://api.openweathermap.org/data/2.5/weather?lat=" + e.latlng.lat + '&lon=' + e.latlng.lng + "&appid=" + weather_key + "&units=metric")
                    .then(function (resp) { return resp.json() })
                    .then(function (data) {
                        console.log(data);
                        // storing json data in variables
                        weatherlocation_lon = data.coord.lon; // lon WGS84
                        weatherlocation_lat = data.coord.lat; // lat WGS84
                        weatherstationname = data.name // Name of Weatherstation
                        weatherstationid = data.id // ID of Weatherstation
                        weathertime = data.dt // Time of weatherdata (UTC)
                        temperature = data.main.temp;
                        airpressure = data.main.pressure; // hPa
                        airhumidity = data.main.humidity; // %
                        temperature_min = data.main.temp_min;
                        temperature_max = data.main.temp_max;
                        windspeed = data.wind.speed; // Meter per second
                        winddirection = data.wind.deg; // Wind from direction x degree from north
                        cloudcoverage = data.clouds.all; // Cloudcoverage in %
                        weatherconditionid = data.weather[0].id // ID
                        weatherconditionstring = data.weather[0].main // Weatheartype
                        weatherconditiondescription = data.weather[0].description // Weatherdescription
                        weatherconditionicon = data.weather[0].icon // ID of weathericon

                        // Converting Unix UTC Time
                        var utctimecalc = new Date(weathertime * 1000);
                        var months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
                        var year = utctimecalc.getFullYear();
                        var month = months[utctimecalc.getMonth()];
                        var date = utctimecalc.getDate();
                        var hour = utctimecalc.getHours();
                        var min = utctimecalc.getMinutes();
                        var sec = utctimecalc.getSeconds();
                        var time = date + '.' + month + '.' + year + ' ' + hour + ':' + min + ' Uhr';

                        // recalculating
                        var weathercondtioniconhtml = "http://openweathermap.org/img/w/" + weatherconditionicon + ".png";
                        var weathertimenormal = time; // reallocate time var....
                        var temperaturef = Math.round((temperature * 9 / 5) + 32);  // Converting Celsius to Fahrenheit
                        var windspeedknots = Math.round((windspeed * 1.94) * 100) / 100; // Windspeed from m/s in Knots; Round to 2 decimals
                        var windspeedkmh = Math.round((windspeed * 3.6) * 100) / 100; // Windspeed from m/s in km/h; Round to 2 decimals
                        var winddirectionstring = "Im the wind from direction"; // Wind from direction x as text
                        if (winddirection > 348.75 && winddirection <= 11.25) {
                            winddirectionstring = "North";
                        } else if (winddirection > 11.25 && winddirection <= 33.75) {
                            winddirectionstring = "North-Northeast";
                        } else if (winddirection > 33.75 && winddirection <= 56.25) {
                            winddirectionstring = "Northeast";
                        } else if (winddirection > 56.25 && winddirection <= 78.75) {
                            winddirectionstring = "East-Northeast";
                        } else if (winddirection > 78.75 && winddirection <= 101.25) {
                            winddirectionstring = "East";
                        } else if (winddirection > 101.25 && winddirection <= 123.75) {
                            winddirectionstring = "East-Southeast";
                        } else if (winddirection > 123.75 && winddirection <= 146.25) {
                            winddirectionstring = "Southeast";
                        } else if (winddirection > 146.25 && winddirection <= 168.75) {
                            winddirectionstring = "South-Southeast";
                        } else if (winddirection > 168.75 && winddirection <= 191.25) {
                            winddirectionstring = "South";
                        } else if (winddirection > 191.25 && winddirection <= 213.75) {
                            winddirectionstring = "South-Southwest";
                        } else if (winddirection > 213.75 && winddirection <= 236.25) {
                            winddirectionstring = "Southwest";
                        } else if (winddirection > 236.25 && winddirection <= 258.75) {
                            winddirectionstring = "West-Southwest";
                        } else if (winddirection > 258.75 && winddirection <= 281.25) {
                            winddirectionstring = "West";
                        } else if (winddirection > 281.25 && winddirection <= 303.75) {
                            winddirectionstring = "West-Northwest";
                        } else if (winddirection > 303.75 && winddirection <= 326.25) {
                            winddirectionstring = "Northwest";
                        } else if (winddirection > 326.25 && winddirection <= 348.75) {
                            winddirectionstring = "North-Northwest";
                        } else {
                            winddirectionstring = " - currently no wind data available - ";
                        };

                        //Popup with content
                        var fontsizesmall = 1;
                        weather_popup.setContent("<h2 style='margin: 0;'>" + weatherstationname + "</h2>" +
                        "<img src=" + weathercondtioniconhtml + "><br>" +
                        weatherconditionstring +
                        // " (Weather-ID: " + weatherconditionid + "): " +
                        ": " + weatherconditiondescription + "<br><br>Temperature: " +
                        temperature + "°C<br>Air pressure: " + airpressure +
                        " hPa<br>Humidity: " + airhumidity + "%" + "<br>Cloud coverage: " +
                        cloudcoverage + "%<br><br>Wind speed: " + windspeedkmh +
                        " km/h<br>Wind from direction: " + winddirectionstring +
                        " (" + winddirection + "°)" + "<br><br><font size=" +
                        fontsizesmall + ">Data source:<br>openweathermap.org<br>Measure time: " +
                        weathertimenormal + "<br>Weatherstation-ID: " + weatherstationid +
                        "<br>Weather station coordinates: " + weatherlocation_lon + ", " + weatherlocation_lat);
                    });

                    map.flyTo(e.latlng, 8);
                }

                // countryCenters.on('click', onEachFeature);
                map.on('click', onMapClick);
            });

        </script>
    </body>
    <footer class="container">
      <p class="float-end"><a href="#">Back to top</a></p>
      <p> Weather and Twitter Exploration 2021 &copy; </p>
    </footer>
</html>
